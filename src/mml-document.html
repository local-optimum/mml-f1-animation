<html>
  <body>
    <!-- Scene Lighting -->
    <!-- Main overhead light -->
    <m-light
        type="point"
        intensity="800"
        x="0"
        y="15"
        z="0"
        distance="50"
    ></m-light>
    
    <!-- Front lighting -->
    <m-light
        type="point"
        intensity="600"
        x="0"
        y="8"
        z="20"
        distance="40"
    ></m-light>
    
    <!-- Back lighting -->
    <m-light
        type="point"
        intensity="400"
        x="0"
        y="8"
        z="-20"
        distance="40"
    ></m-light>
    
    <!-- Side lighting -->
    <m-light
        type="point"
        intensity="500"
        x="20"
        y="8"
        z="0"
        distance="40"
    ></m-light>

    <!-- Labels -->
    <m-group y="5">
      <m-label
          id="uptime-label"
          y="2"
          width="4"
          height="0.5"
          color="#bfdbfe"
          font-color="#172554"
          alignment="center"
      ></m-label>
      <m-label
          id="connected-label"
          y="1"
          width="4"
          height="0.5"
          color="#bfdbfe"
          font-color="#172554"
          alignment="center"
      ></m-label>
      <m-label
          id="click-label"
          width="4"
          height="0.5"
          color="#bfdbfe"
          font-color="#172554"
          alignment="center"
          content="Click the dice!"
      ></m-label>
    </m-group>

    <!-- Dice -->
    <m-model
        id="dice"
        src="/assets/dice.glb"
        onclick="rollDice()"
        y="1"
    >
      <m-attr-anim id="y-up-anim" easing="easeOutSine" attr="y" duration="300" start="1" end="1" loop="false"></m-attr-anim>
      <m-attr-anim id="y-down-anim" easing="easeOutBounce" attr="y" start-time="0" duration="500" start="1" end="1" loop="false"></m-attr-anim>
      <m-attr-anim id="rx-anim" easing="easeInOutCubic" attr="rx" duration="500" start="0" end="0" loop="false"></m-attr-anim>
      <m-attr-anim id="ry-anim" easing="easeInOutCubic" attr="ry" duration="500" start="0" end="0" loop="false"></m-attr-anim>
      <m-attr-anim id="rz-anim" easing="easeInOutCubic" attr="rz" duration="500" start="0" end="0" loop="false"></m-attr-anim>
    </m-model>

    <!-- Moving Cubes Group -->
    <m-group id="moving-cubes-group" x="-5" y="0" z="0">
      <!-- Cube 1 -->
      <m-cube 
          id="cube1" 
          x="0" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#3671C6"
      ></m-cube>
      <m-label 
          id="label1" 
          x="0" 
          y="0.5" 
          z="0" 
          content="Driver 4" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>
      
      <!-- Cube 2 -->
      <m-cube 
          id="cube2" 
          x="0.5" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#F91536"
      ></m-cube>
      <m-label 
          id="label2" 
          x="0.5" 
          y="0.5" 
          z="0" 
          content="Driver 81" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>
      
      <!-- Cube 3 -->
      <m-cube 
          id="cube3" 
          x="1" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#FF8700"
      ></m-cube>
      <m-label 
          id="label3" 
          x="1" 
          y="0.5" 
          z="0" 
          content="Driver 27" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 4 -->
      <m-cube 
          id="cube4" 
          x="1.5" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#6CD3BF"
      ></m-cube>
      <m-label 
          id="label4" 
          x="1.5" 
          y="0.5" 
          z="0" 
          content="Driver 44" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 5 -->
      <m-cube 
          id="cube5" 
          x="2" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#358C75"
      ></m-cube>
      <m-label 
          id="label5" 
          x="2" 
          y="0.5" 
          z="0" 
          content="Driver 1" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 6 -->
      <m-cube 
          id="cube6" 
          x="2.5" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#2293D1"
      ></m-cube>
      <m-label 
          id="label6" 
          x="2.5" 
          y="0.5" 
          z="0" 
          content="Driver 10" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 7 -->
      <m-cube 
          id="cube7" 
          x="3" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#37BEDD"
      ></m-cube>
      <m-label 
          id="label7" 
          x="3" 
          y="0.5" 
          z="0" 
          content="Driver 18" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 8 -->
      <m-cube 
          id="cube8" 
          x="3.5" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#5E8FAA"
      ></m-cube>
      <m-label 
          id="label8" 
          x="3.5" 
          y="0.5" 
          z="0" 
          content="Driver 23" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 9 -->
      <m-cube 
          id="cube9" 
          x="4" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#52E252"
      ></m-cube>
      <m-label 
          id="label9" 
          x="4" 
          y="0.5" 
          z="0" 
          content="Driver 14" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 10 -->
      <m-cube 
          id="cube10" 
          x="4.5" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#B6BABD"
      ></m-cube>
      <m-label 
          id="label10" 
          x="4.5" 
          y="0.5" 
          z="0" 
          content="Driver 63" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 11 -->
      <m-cube 
          id="cube11" 
          x="5" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#3671C6"
      ></m-cube>
      <m-label 
          id="label11" 
          x="5" 
          y="0.5" 
          z="0" 
          content="Driver 87" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 12 -->
      <m-cube 
          id="cube12" 
          x="5.5" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#F91536"
      ></m-cube>
      <m-label 
          id="label12" 
          x="5.5" 
          y="0.5" 
          z="0" 
          content="Driver 55" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 13 -->
      <m-cube 
          id="cube13" 
          x="6" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#FF8700"
      ></m-cube>
      <m-label 
          id="label13" 
          x="6" 
          y="0.5" 
          z="0" 
          content="Driver 31" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 14 -->
      <m-cube 
          id="cube14" 
          x="6.5" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#6CD3BF"
      ></m-cube>
      <m-label 
          id="label14" 
          x="6.5" 
          y="0.5" 
          z="0" 
          content="Driver 16" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 15 -->
      <m-cube 
          id="cube15" 
          x="7" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#358C75"
      ></m-cube>
      <m-label 
          id="label15" 
          x="7" 
          y="0.5" 
          z="0" 
          content="Driver 22" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 16 -->
      <m-cube 
          id="cube16" 
          x="7.5" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#2293D1"
      ></m-cube>
      <m-label 
          id="label16" 
          x="7.5" 
          y="0.5" 
          z="0" 
          content="Driver 12" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 17 -->
      <m-cube 
          id="cube17" 
          x="8" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#37BEDD"
      ></m-cube>
      <m-label 
          id="label17" 
          x="8" 
          y="0.5" 
          z="0" 
          content="Driver 6" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 18 -->
      <m-cube 
          id="cube18" 
          x="8.5" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#5E8FAA"
      ></m-cube>
      <m-label 
          id="label18" 
          x="8.5" 
          y="0.5" 
          z="0" 
          content="Driver 5" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 19 -->
      <m-cube 
          id="cube19" 
          x="9" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#52E252"
      ></m-cube>
      <m-label 
          id="label19" 
          x="9" 
          y="0.5" 
          z="0" 
          content="Driver 30" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>

      <!-- Cube 20 -->
      <m-cube 
          id="cube20" 
          x="9.5" 
          y="0" 
          z="0" 
          width="0.3" 
          height="0.3" 
          depth="0.3" 
          color="#B6BABD"
      ></m-cube>
      <m-label 
          id="label20" 
          x="9.5" 
          y="0.5" 
          z="0" 
          content="Driver 43" 
          font-size="12" 
          font-color="black"
          width="1.5" 
          height="0.3"
      ></m-label>
    </m-group>

    <script>
      // Get elements
      const uptimeLabelElem = document.getElementById("uptime-label");
      const connectedLabelElem = document.getElementById("connected-label");
      const yUpAnim = document.getElementById("y-up-anim");
      const yDownAnim = document.getElementById("y-down-anim");
      const rxAnim = document.getElementById("rx-anim");
      const ryAnim = document.getElementById("ry-anim");
      const rzAnim = document.getElementById("rz-anim");
      const diceClickLabelElem = document.getElementById("click-label");

      // Moving cubes elements
      const movingCubesGroup = document.getElementById("moving-cubes-group");
      const cubes = [];
      const labels = [];
      
      // Create array of all cube elements and labels
      for (let i = 1; i <= 20; i++) {
        const cube = document.getElementById(`cube${i}`);
        const label = document.getElementById(`label${i}`);
        if (cube) {
          cubes.push(cube);
        }
        if (label) {
          labels.push(label);
        }
      }
      
      console.log(`Found ${cubes.length} cube elements and ${labels.length} labels`);

      // Prepare document state
      let diceResult = 1;
      let connectedClientCount = 0;
      let diceClickCount = 0;
      let rollTime = 0;
      const rollMap = {
        1: [0, 0, 0],
        2: [0, 0, 270],
        3: [270, 0, 0],
        4: [90, 0, 0],
        5: [0, 0, 90],
        6: [180, 0, 0],
      };

      // Coordinate data will be loaded asynchronously
      let cubeCoordinates = [];
      let coordinateConfig = {};
      let driverInfo = [];
      let currentTimeIndex = 0;
      let coordinatesLoaded = false;

      // Load coordinate data from external file
      async function loadCoordinates() {
        try {
          const response = await fetch('http://localhost:8080/assets/f1-coordinates.js');
          const scriptText = await response.text();
          
          // Execute the script in a safe way to extract the data
          const scriptFunction = new Function(scriptText + '; return { cubeCoordinates, coordinateConfig, driverInfo, getCoordinatesAtTimeStep, getCurrentTimeStep };');
          const data = scriptFunction();
          
          cubeCoordinates = data.cubeCoordinates;
          coordinateConfig = data.coordinateConfig;
          driverInfo = data.driverInfo || [];
          window.getCoordinatesAtTimeStep = data.getCoordinatesAtTimeStep;
          window.getCurrentTimeStep = data.getCurrentTimeStep;
          coordinatesLoaded = true;

          // Update labels with driver names
          updateDriverLabels();

          // Start the cube movement system
          setInterval(updateCubePositions, coordinateConfig.updateInterval);
        } catch (error) {
          console.error('Failed to load coordinates:', error);
        }
      }

      // Function to update driver labels
      function updateDriverLabels() {
        for (let i = 0; i < labels.length && i < driverInfo.length; i++) {
          const label = labels[i];
          const driver = driverInfo[i];
          if (label && driver) {
            label.setAttribute("content", driver.driver_name);
          }
        }
      }

      // Function to update cube positions based on coordinates
      function updateCubePositions() {
        if (!coordinatesLoaded) return;

        const currentTime = document.timeline.currentTime;
        const timeStep = getCurrentTimeStep(currentTime);

        if (timeStep !== currentTimeIndex) {
          currentTimeIndex = timeStep;

          // Get coordinates for current time step
          const coordinates = getCoordinatesAtTimeStep(timeStep);

          // Update each cube's position and its corresponding label
          for (let i = 0; i < cubes.length; i++) {
            const cube = cubes[i];
            const label = labels[i];
            if (cube && coordinates[i]) {
              // Update cube position
              cube.setAttribute("x", coordinates[i].x.toString());
              cube.setAttribute("y", coordinates[i].y.toString());
              cube.setAttribute("z", coordinates[i].z.toString());
              
              // Update label position to be above the cube
              if (label) {
                label.setAttribute("x", coordinates[i].x.toString());
                label.setAttribute("y", (coordinates[i].y + 0.5).toString()); // 0.5 units above the cube
                label.setAttribute("z", coordinates[i].z.toString());
              }
            }
          }
        }
      }

      // Initialize coordinate loading
      loadCoordinates();

      function rollDice() {
        diceClickCount++;
        updateDiceClickCountLabel();

        const t = document.timeline.currentTime + 50;
        if (t < rollTime + 800) {
          return;
        }
        rollTime = t;
        const oldRotation = rollMap[diceResult];
        diceResult = Math.floor(Math.random() * 6) + 1;
        const targetRotation = rollMap[diceResult];
        yUpAnim.setAttribute("start-time", t);
        yUpAnim.setAttribute("end", 3);
        yDownAnim.setAttribute("start-time", t+300);
        yDownAnim.setAttribute("start", 3);
        yDownAnim.setAttribute("end", 1);
        rxAnim.setAttribute("start-time", t);
        rxAnim.setAttribute("start", oldRotation[0].toString());
        rxAnim.setAttribute("end", targetRotation[0].toString());
        ryAnim.setAttribute("start-time", t);
        ryAnim.setAttribute("start", oldRotation[1].toString());
        ryAnim.setAttribute("end", targetRotation[1].toString());
        rzAnim.setAttribute("start-time", t);
        rzAnim.setAttribute("start", oldRotation[2].toString());
        rzAnim.setAttribute("end", targetRotation[2].toString());
      }

      const updateUptimeLabel = () => {
        // Get total document uptime
        // NOTE: document.timeline.currentTime reports uptime in ms
        const totalUptimeSeconds = Math.floor(document.timeline.currentTime / 1000);
        const uptimeMinutes = Math.floor(totalUptimeSeconds / 60);
        const uptimeSeconds = totalUptimeSeconds - uptimeMinutes * 60;
        const uptimeLabelText =
          uptimeMinutes > 0
            ? `${uptimeMinutes}:${String(uptimeSeconds).padStart(2, "0")}`
            : `${uptimeSeconds}s`;

        uptimeLabelElem.setAttribute("content", `Uptime: ${uptimeLabelText}`);
      };

      const updateConnectedCountLabel = () => {
        connectedLabelElem.setAttribute("content", `Connected clients: ${connectedClientCount}`);
      };

      const updateDiceClickCountLabel = () => {
        diceClickLabelElem.setAttribute("content", `Dice clicks: ${diceClickCount}`);
      };

      // Refresh document uptime
      updateUptimeLabel();
      setInterval(updateUptimeLabel, 1000);

      // Client connection listeners
      window.addEventListener("connected", () => {
        connectedClientCount++;
        updateConnectedCountLabel();
      });
      window.addEventListener("disconnected", () => {
        connectedClientCount--;
        updateConnectedCountLabel();
      });
    </script>
  </body>
</html>
